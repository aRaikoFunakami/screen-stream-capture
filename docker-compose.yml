services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8000:8000"
    volumes:
      # editable install のためソースをマウント
      - ./packages/android-screen-stream:/app/packages/android-screen-stream:ro
      - ./backend:/app/backend
      - ./vendor:/app/vendor:ro
    environment:
      - SCRCPY_SERVER_JAR=/app/vendor/scrcpy-server.jar
      # ホストの adb server を使用
      - ADB_SERVER_SOCKET=tcp:host.docker.internal:5037
      # adb forward で開いたポートはホスト側なので host.docker.internal に接続
      - SCRCPY_CONNECT_HOST=host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build:
      context: .
      dockerfile: examples/simple-viewer/frontend/Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./packages/react-android-screen:/app/packages/react-android-screen:ro
      - ./examples/simple-viewer/frontend:/app/frontend
      - /app/frontend/node_modules  # node_modules はコンテナ内で管理
    depends_on:
      - backend
    command: npm run dev -- --host 0.0.0.0
